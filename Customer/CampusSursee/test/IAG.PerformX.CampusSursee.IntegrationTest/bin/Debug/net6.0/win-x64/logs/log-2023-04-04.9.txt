2023-04-04 13:58:52.9203|INFO|IAG.IdentityServer.Startup.ConfigureIdentityServer|Registering identity-plugin IAG.IdentityServer.Plugin.AtlasMitarbeiter
2023-04-04 13:58:52.9834|INFO|IAG.IdentityServer.Startup.ConfigureIdentityServer|Registering identity-plugin IAG.IdentityServer.Plugin.AtlasAdresse
2023-04-04 13:58:52.9834|INFO|IAG.IdentityServer.Startup.ConfigureIdentityServer|Registering identity-plugin IAG.IdentityServer.Plugin.UserDatabaseAuthentication
2023-04-04 13:58:57.7382|DEBUG|IAG.Infrastructure.Middleware.LoggingMiddleware|Received GET request '0HMPL0FSBCV0M:00000002' to 'http://localhost:8085/api/Core/CampusSursee/Event/Event?%24top=10 with 0 bytes of data of type Accept: application/json;odata.metadata=minimal;odata.streaming=true
Connection: keep-alive
Host: localhost:8085
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en
Referer: http://localhost:8085/swagger/index.html?urls.primaryName=I-AG%20Campus%20Sursee%20API
sec-ch-ua: "Brave";v="111", "Not(A:Brand";v="8", "Chromium";v="111"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Windows"
Sec-GPC: 1
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty

2023-04-04 13:58:57.9768|DEBUG|IAG.Common.DataLayerSybase.SybaseConnection|Execute SQL '
                SET TEMPORARY OPTION CONNECTION_AUTHENTICATION=
                'Company=Opus Software AG;Application=Atlas Framework;Signature=000fa55157edb8e14d818eb4fe3db41447146f1571g7b927fa0b2d30a756f0d29b8fd5e7a1b91124be6''
2023-04-04 13:58:58.0038|DEBUG|IAG.Common.DataLayerSybase.SybaseConnection|Execute SQL '
                        SELECT Sys_Version, Sys_Languages FROM xStateSystem WHERE Sys_Tag = 'Main';
                        SELECT COUNT(1) FROM SYS.SYSCATALOG WHERE SYS.SYSCATALOG.tabletype = 'TABLE' AND SYS.SYSCATALOG.tname = 'BEREICH';
                        SELECT Mit_Id FROM Mitarbeiter WHERE Mit_Login = 'Support';
                        SELECT Sys_Tag FROM xStateSystem WHERE Sys_Tag IN ('Online','DigitalDrink')'
2023-04-04 13:58:58.0575|DEBUG|IAG.Common.DataLayerSybase.SybaseConnection|Execute SQL '
                WITH AtlasResourceBase (
                    Name, Language, Translation
                ) AS (
                SELECT PhysMetaAtt_NameInDB, 'de', PhysMetaAtt_NameForUser
                FROM PhysMetaAttribute       
                WHERE TRIM(ISNULL(PhysMetaAtt_NameInDB, '')) != '' 
                ),
                AtlasResource (
                    Name, Language, Translation, RowNum
                ) AS (
                SELECT 
                    'Atlas.' + Name, Language, Translation, 
                    ROW_NUMBER() over (partition by Name, Language order by Name, Language)
                FROM AtlasResourceBase
                WHERE Translation IS NOT NULL
                )
                SELECT DISTINCT Name, Language, Translation 
                FROM AtlasResource 
                WHERE RowNum = 1 
                ORDER BY Name'
2023-04-04 13:58:58.3830|DEBUG|IAG.Common.DataLayerSybase.SybaseConnection|Execute SQL '
        WITH EventBase (
            Id, Number, Title, SubTitle, EventKindName, 
            EventKindId, EventStatusName, EventStatusId, MarketingPush, 
            Publish, PublishFrom, PublishUntil, 
            Language, Place, DateStart, 
            DateEnd, AttendeesMin,
            AttendeesMax, WaitinglistMax, 
            WaitinglistCurrent, 
            AttendeesCurrent,
            ContactMail, ParifondCode, EntranceExamDate, RegistrationFormId, InfoUrl,
            SasExecution,
            LastChange,
            IstExklusiv
        ) AS (
        SELECT
            VerDef.VerDef_Id, VerDef.VerDef_Nummer, VerDef.VerDef_Name, VerDef.VerDef_Untertitel, Kind.Typ_Bezeichnung,
            Kind.Typ_Id, Gruppenstatus_Bezeichnung, Gruppenstatus_Id, CASE IsNull(VerDef.VerDef_MarketingPush, 0) WHEN 0 THEN 0 ELSE 1 END, 
            CASE VerDef.VerDef_Publizieren WHEN 0 THEN 0 ELSE 1 END, VerDef.VerDef_PublizierenAb, VerDef.VerDef_PublizierenBis,
            Lan.Typ_Bezeichnung, VerDef.VerDef_Durchfuehrungsort, VerDef.VerDef_Beginn + IsNull(VerDef.VerDef_Beginnzeit, CONVERT(TIME, '0', 14)), 
            VerDef.VerDef_Ende + IsNull(VerDef.VerDef_Endezeit, CONVERT(TIME, '0', 14)), VerDef.VerDef_MinTN,
            VerDef.VerDef_MaxTN, VerDef.VerDef_MaxWarteliste, 
            VerDef.VerDef_AnzahlWarteliste + SUM(CASE Ver_CSaufWarteliste WHEN -1 THEN Ver_Personen ELSE 0 END), 
            VerDef.VerDef_AnzahlTeilnehmer + SUM(CASE Ver_CSaufWarteliste WHEN 0 THEN Ver_Personen ELSE 0 END), 
            Mit_Email, Sequenz_Bezeichnung, VerDef.VerDef_Aufnahmepruefung, Template.VerDef_AnmeldeformularID, Template.VerDef_URLInformationenZurAusbildung,
            VerDef.VerDef_SASDurchfuehrung,
            GREATER(VerDef.VerDef_ChangedOn, Template.VerDef_ChangedOn),
            Kind.Typ_IstExklusiv
        FROM VertragDef_View VerDef
        LEFT OUTER JOIN VertragDef Template ON VerDef.VerDef_SASEreignisVorlage = Template.VerDef_Id
        LEFT OUTER JOIN Typ Kind ON Kind.Typ_Id = VerDef.VerDef_GebietId
        LEFT OUTER JOIN Typ Lan ON Lan.Typ_Id = VerDef.VerDef_ThemaID
        LEFT OUTER JOIN Gruppenstatus ON Gruppenstatus_Id = VerDef.VerDef_StatusID
        LEFT OUTER JOIN Mitarbeiter ON VerDef.VerDef_Assistent_Beginn = Mit_Id
        LEFT OUTER JOIN OnlineVertrag ON Ver_VertragDefID = VerDef.VerDef_Id AND Ver_VertragId IS NULL
        LEFT OUTER JOIN Sequenz ON VerDef.VerDef_SequenzID = Sequenz_ID
        WHERE VerDef.VerDef_BereichId = 2
        GROUP BY 
            VerDef.VerDef_Id, VerDef.VerDef_Nummer, VerDef.VerDef_Name, VerDef.VerDef_Untertitel, Kind.Typ_Bezeichnung,
            Kind.Typ_Id, Gruppenstatus_Bezeichnung, Gruppenstatus_Id, CASE IsNull(VerDef.VerDef_MarketingPush, 0) WHEN 0 THEN 0 ELSE 1 END, 
            CASE VerDef.VerDef_Publizieren WHEN 0 THEN 0 ELSE 1 END, VerDef.VerDef_PublizierenAb, VerDef.VerDef_PublizierenBis,
            Lan.Typ_Bezeichnung, VerDef.VerDef_Durchfuehrungsort, VerDef.VerDef_Beginn + IsNull(VerDef.VerDef_Beginnzeit, CONVERT(TIME, '0', 14)), 
            VerDef.VerDef_Ende + IsNull(VerDef.VerDef_Endezeit, CONVERT(TIME, '0', 14)), VerDef.VerDef_MinTN,
            VerDef.VerDef_MaxTN, VerDef.VerDef_MaxWarteliste, 
            VerDef.VerDef_AnzahlWarteliste, 
            VerDef.VerDef_AnzahlTeilnehmer, 
            Mit_Email, Sequenz_Bezeichnung, VerDef.VerDef_Aufnahmepruefung, Template.VerDef_AnmeldeformularID, Template.VerDef_URLInformationenZurAusbildung,
            VerDef.VerDef_SASDurchfuehrung,
            GREATER(VerDef.VerDef_ChangedOn, Template.VerDef_ChangedOn),
            Kind.Typ_IstExklusiv
        ),
        AdditionalEvent (
            EventId, AtlasInfo, TypeId, LastChange
        ) AS (
        SELECT
            VertragDefZusatz_VertragDefID, VertragDefZusatz_Text, VertragDefZusatz_ZusatzTypID, 
            VertragDefZusatz_ChangedOn
        FROM VertragDefZusatz 
        JOIN VertragDef ON VertragDefZusatz_VertragDefID = VerDef_Id
        WHERE VerDef_BereichId = 2
        ),
        AdditionalTemplate (
            EventId, AtlasInfo, TypeId, 
            AtlasDocumentId, FileName, LastChange
        ) AS (
        SELECT
            verdef.VerDef_ID, VertragDefZusatz_Text, VertragDefZusatz_ZusatzTypID, 
            CASE IsNull(VertragDefZusatz_Datei, '') WHEN '' THEN NULL ELSE VertragDefZusatz_Id END, VertragDefZusatz_Datei, 
            VertragDefZusatz_ChangedOn
        FROM VertragDefZusatz 
        JOIN VertragDef template ON VertragDefZusatz_VertragDefID = template.VerDef_Id
        JOIN VertragDef verdef ON verdef.VerDef_SASEreignisVorlage = template.VerDef_Id
        WHERE verdef.VerDef_BereichId = 2
        ),
        Category (
            EventId, CategoryName, LastChange
        ) AS (
        SELECT
            verdef.VerDef_ID, List(level1.ECG_Bezeichnung + '>' + level2.ECG_Bezeichnung, ';'), 
            GREATER(GREATER(Max(ECGZV_ChangedOn), MAX(level1.ECG_ChangedOn)), MAX(level1.ECG_ChangedOn))
        FROM ECommerceGruppeZuVertragDef 
        JOIN ECommerceGruppe level2 ON level2.ECG_Id = ECGZV_ECommerceGruppeID
        JOIN ECommerceGruppe level1 ON level1.ECG_Id = level2.ECG_ECommerceGruppeIDUebergeordnet
        JOIN VertragDef template ON ECGZV_VertragDefID = template.VerDef_Id
        JOIN VertragDef verdef ON verdef.VerDef_SASEreignisVorlage = template.VerDef_Id
        WHERE verdef.VerDef_BereichId = 2
        GROUP BY verdef.VerDef_ID
        ),
        Event (
            Id, Number, Title, SubTitle, EventKindName, 
            EventKindId, EventStatusName, EventStatusId, MarketingPush, Publish, PublishFrom, PublishUntil, 
            Language, Place, DateStart, DateEnd, AttendeesMin,
            AttendeesMax, WaitinglistMax, WaitinglistCurrent, AttendeesCurrent,
            ContactMail, ParifondCode, EntranceExamDate, EntranceExamInfoAtlas, EventAdditionalPriceAtlas,
            EventAvvPriceAtlas, EventDurationAtlas, EventAdditionalInfoAtlas, EventCategories, RegistrationFormId, 
            InfoUrl, SasExecution,
            LastChange
        ) AS (
        SELECT
            EventBase.Id, Number, Title, SubTitle, EventKindName, 
            EventKindId, EventStatusName, EventStatusId, MarketingPush, Publish, PublishFrom, PublishUntil, 
            Language, Place, DateStart, DateEnd, AttendeesMin,
            AttendeesMax, WaitinglistMax, WaitinglistCurrent, AttendeesCurrent,
            ContactMail, ParifondCode, EntranceExamDate, AddExam.AtlasInfo, AddPrice.AtlasInfo,
            AddAvv.AtlasInfo, AddDur.AtlasInfo, AddAdd.AtlasInfo, CategoryName, RegistrationFormId, 
            InfoUrl, SasExecution,
            GREATER(
                GREATER(
                    GREATER(
                        GREATER(
                            GREATER(
                                GREATER(
                                    EventBase.LastChange, 
                                    Category.LastChange),
                                isnull(AddExam.LastChange, now()-300)), 
                            isnull(AddPrice.LastChange, now()-300)), 
                        isnull(AddAvv.LastChange, now()-300)), 
                    isnull(AddDur.LastChange, now()-300)), 
                isnull(AddAdd.LastChange, now()-300))
        FROM EventBase
        LEFT OUTER JOIN AdditionalEvent AddExam ON EventBase.Id = AddExam.EventId AND AddExam.TypeId = 251
        LEFT OUTER JOIN AdditionalEvent AddAdd ON EventBase.Id = AddAdd.EventId AND AddAdd.TypeId = 252
        LEFT OUTER JOIN AdditionalTemplate AddPrice ON EventBase.Id = AddPrice.EventId AND AddPrice.TypeId = 211
        LEFT OUTER JOIN AdditionalTemplate AddAvv ON EventBase.Id = AddAvv.EventId AND AddAvv.TypeId = 212
        LEFT OUTER JOIN AdditionalTemplate AddDur ON EventBase.Id = AddDur.EventId AND AddDur.TypeId = 213
        LEFT OUTER JOIN Category ON EventBase.Id = Category.EventId
        )
    SELECT TOP ? T.Id,T.Number,T.Title,T.SubTitle,T.RegistrationFormId,T.InfoUrl,T.EventKindName,T.EventKindId,T.EventStatusName,T.EventStatusId,T.MarketingPush,T.Publish,T.PublishFrom,T.PublishUntil,T.Language,T.Place,T.DateStart,T.DateEnd,T.AttendeesMin,T.AttendeesMax,T.WaitinglistMax,T.WaitinglistCurrent,T.AttendeesCurrent,T.ContactMail,T.ParifondCode,T.SasExecution,T.EntranceExamDate,T.EntranceExamInfoAtlas,T.EventAdditionalPriceAtlas,T.EventAvvPriceAtlas,T.EventDurationAtlas,T.EventAdditionalInfoAtlas,T.EventCategories,T.LastChange,T.IstExklusiv
FROM Event T
' with parameters: 10
